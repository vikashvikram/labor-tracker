<p id="notice"><%= notice %></p>
<div class="page-header">
  <h2><%= @patient.name%></h2>
</div>
<div class="row">
  <div class="col-lg-3">
    <div class="thumbnail" style="border: none">
      <%= image_tag 'anisha.jpg' %>
      <div class="caption">
        <p><b> Name: </b> <%= @patient.name%></p>
        <p><b> Date of Birth: </b> <%= @patient.dob.strftime('%B %d, %Y')%></p>
        <p><b> ID Number: </b> <%= @patient.id_num%> (<%= @patient.id_type %>)</p>
        <p><b> Address: </b> <%= @patient.place%>, <%= @patient.district%>, <%= @patient.state%></p>
        <p><b> Area Code: </b> <%= @patient.pincode%></p>
        <p><b> Blood type: </b> <%= @patient.blood_type%></p>
      </div>
    </div>
  </div>
  <div class="col-lg-9">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Medical Profile and History of <%= @patient.name%></h3>
       </div>
        <div class="panel-body">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h4 class="panel-title">Medical History</h4>
            </div>
            <div class="panel-body">
              <p> Find below all medical history of <%= @patient.name %>. It will list down child births, operations, accidents and miscarriages</p>
            </div>
            <% history = @patient.medical_histories %>
            <table class="table">
              <tr>
                <th>Date</th>
                <th>Incident</th>
                <th>Comment</th>
              </tr>
              <% history.each do |h| %>
              <tr>
                <td><%= h.date.strftime('%B %d, %Y')%></td>
                <td><%= h.incident_type%></td>
                <td><%= h.comment%></td>
              </tr>
              <%end%>
            </table>
          </div>
          <div class="panel panel-default">
            <div class="panel-heading">
              <h4 class="panel-title">Previous Tests</h4>
            </div>
            <div class="panel-body">
              <% tests = @patient.medical_tests%>
              <% tests.each do |t| %>
              <div class="col-lg-12">
                <div class="thumbnail" style="border: none">
                  <div class="caption">
                    <div class="page-header">
                      <h4>Test done on <%= t.date.strftime('%B %d, %Y')%> by <%=link_to current_user.name, root_url%></h4>
                    </div>
                    <p><b> Heart Rate: </b> <%= t.heart_rate%></p>
                    <p><b> Fetus Heart Sound: </b> <%= t.fetal_heart_sound%></p>
                    <p><b> Uterus Contraction: </b> <%= t.uterus_contraction%></p>
                    <p><b> Sugar: </b> <%= t.sugar%> mg/dL</p>
                    <p><b> Weight: </b> <%= t.weight%> Kg</p>
                    <p><b> Blood Pressure: </b> <%= t.blood_pressure%></p>
                    <p><b> Hemoglogin: </b> <%= t.hemoglobin%> gm/dL</p>
                    <p><b> Nicotine: </b> <%= t.tobacco%></p>
                    <p><b> Alcohol: </b> <%= t.alcohol%>%</p>
                    <p><b> Platelet Count: </b> <%= t.platelet_count%></p>
                  </div>
                </div>
              </div>
              <%end%>
            </div>
          </div>
          <div class="panel panel-default">
            <div class="panel-heading">
              <h4 class="panel-title">RealTime Diagnosis</h4>
            </div>
            <div class="panel-body">
              <div id="chartContainer" style="height: 300px; width: 100%;"></div>
            </div>
          </div>
        </div>
    </div>
  </div>
</div>
<script>
    var dps = [{x: 0, y: 0}]; 
    var updateChart = function (xVal, yVal) {
          
          dps.push({x: xVal,y: yVal});
          
          if (dps.length >  10 )
          {
            dps.shift();        
          }

          chart.render();   

  };


  var chart = new CanvasJS.Chart("chartContainer",{
    title :{
      text: "Live Data"
    },
    axisX: {            
      title: "Axis X Title"
    },
    axisY: {            
      title: "Units"
    },
    data: [{
      type: "line",
      dataPoints : dps
    }]
  });

  chart.render();
  var pusher = new Pusher('<%= Pusher.key%>');
  var channel = pusher.subscribe('private-test_channel');

  channel.bind('ping', function(data) {
    alert(data.message);
  });

  channel.bind('chart', function(data) {
    //alert(data.message);
    updateChart(parseInt(data.xVal), parseInt(data.yVal));
  });

  pusher.connection.bind( 'error', function( err ) { 
    alert('>>> detected limit error');
  });

  pusher.connection.bind('connected', function() {
    //$('div#status').text('Real time is go!');
    alert('connected');
    //document.getElementById('status').innerHTML = "Connected";
  });

  pusher.connection.bind('connecting_in', function() {
    //$('div#status').text('Real time is go!');
    alert('connecting_in');
  });
  
</script>

